import os
import json
from flask import Flask, jsonify, request, render_template, send_from_directory
from werkzeug.utils import secure_filename
from functools import lru_cache

# Eigene Module
from config import SNIPPET_DIR, STATIC_DIR, UPLOAD_DIR
import database
from job_manager import manager as job_manager
from services.processor import resolve_audio_stream_url
import yt_dlp

app = Flask(__name__)

# --- Caching ---
@lru_cache(maxsize=500)
def cached_resolve_audio(query):
    return resolve_audio_stream_url(query)

# --- Frontend Routes ---
@app.route("/")
def index():
    return render_template("index.html")

# --- API: Sets & Tracks ---
@app.route("/api/sets")
def list_sets():
    return jsonify(database.get_all_sets())

@app.route("/api/sets/<int:sid>/tracks")
def list_tracks(sid):
    return jsonify(database.get_tracks_by_set(sid))

@app.route("/api/sets/<int:sid>/rename", methods=["POST"])
def rename_set(sid):
    data = request.get_json(force=True)
    database.rename_set(sid, data.get("name"))
    return jsonify({"ok": True})

@app.route("/api/sets/<int:sid>/metadata", methods=["POST"])
def update_set_metadata(sid):
    data = request.get_json(force=True)
    database.update_set_metadata(sid, data)
    return jsonify({"ok": True})

@app.route("/api/sets/<int:sid>", methods=["DELETE"])
def delete_set(sid):
    database.delete_set(sid)
    return jsonify({"ok": True})

@app.route("/api/tracks/<int:tid>/like", methods=["POST"])
def like_track(tid):
    data = request.get_json(force=True)
    liked = 1 if data.get("liked") else 0
    database.toggle_track_like(tid, liked)
    return jsonify({"ok": True})

@app.route("/api/tracks/likes")
def liked_tracks():
    return jsonify(database.get_liked_tracks())

@app.route("/api/tracks/<int:tid>/flag", methods=["POST"])
def flag_track(tid):
    data = request.get_json(force=True)
    flag = int(data.get("flag", 0))
    database.update_track_flag(tid, flag)
    return jsonify({"ok": True})

# --- API: Queue, Jobs & Metadata ---

@app.route("/api/resolve_metadata", methods=["POST"])
def get_metadata():
    """
    Holt YouTube/Mixcloud Metadaten VOR dem Download,
    um das Modal intelligent auszufüllen.
    """
    data = request.get_json(force=True)
    url = data.get("url")
    if not url: return jsonify({"ok": False}), 400
    
    try:
        # Flat Extraction ist sehr schnell
        opts = {'quiet': True, 'extract_flat': True, 'skip_download': True}
        with yt_dlp.YoutubeDL(opts) as ydl:
            info = ydl.extract_info(url, download=False)
            
            # Smarte Analyse
            title = info.get('title', '')
            uploader = info.get('uploader', '')
            
            # Heuristik: Oft ist Titel "Artist - Trackname"
            artist_guess = uploader
            set_name_guess = title
            event_guess = ""

            # Wenn " - " im Titel ist, splitten wir
            if " - " in title:
                parts = title.split(" - ", 1)
                # Wenn der Uploader im Titel vorkommt (z.B. "HÖR BERLIN"), ist das eher das Event
                if uploader.lower() in title.lower():
                    event_guess = uploader
                    artist_guess = parts[0]
                    set_name_guess = parts[1]
                else:
                    artist_guess = parts[0]
                    set_name_guess = parts[1]
            
            return jsonify({
                "ok": True,
                "artist": artist_guess.strip(),
                "name": set_name_guess.strip(),
                "event": event_guess.strip(),
                "original_title": title,
                "uploader": uploader
            })
            
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500


@app.route("/api/queue/add", methods=["POST"])
def add_job():
    metadata = {}
    job_type = None
    payload = None

    if request.is_json:
        data = request.get_json(force=True)
        job_type = data.get("type")
        payload = data.get("value")
        metadata = data.get("metadata") or {}
    else:
        job_type = request.form.get("type")
        metadata_raw = request.form.get("metadata")
        metadata = json.loads(metadata_raw) if metadata_raw else {}
        payload = request.form.get("value")

    if job_type == "url":
        if not payload: return jsonify({"ok": False, "error": "Keine URL"}), 400
        job_manager.add_job("url", payload, metadata)
        
    elif job_type == "file":
        if request.is_json:
            return jsonify({"ok": False, "error": "File uploads require multipart"}), 400
        if 'file' not in request.files: return jsonify({"ok": False}), 400
        file = request.files['file']
        if file.filename:
            filename = secure_filename(file.filename)
            save_path = os.path.join(UPLOAD_DIR, filename)
            file.save(save_path)
            job_manager.add_job("file", save_path, metadata)
            
    return jsonify({"ok": True})

@app.route("/api/queue/status")
def queue_status():
    return jsonify(job_manager.get_status())

# --- API: Rescan & Audio ---
@app.route("/api/tracks/rescan_candidates")
def rescan_list():
    return jsonify(database.get_rescan_candidates())

@app.route("/api/tracks/rescan_run", methods=["POST"])
def rescan_run():
    database.reset_rescan_flags()
    return jsonify({"ok": True, "processed": 1})

@app.route("/api/resolve_audio", methods=["POST"])
def resolve_audio():
    data = request.get_json(force=True)
    query = data.get("query")
    url = cached_resolve_audio(query)
    if url:
        return jsonify({"ok": True, "url": url})
    return jsonify({"ok": False}), 404

@app.route("/api/dashboard")
def dashboard_stats():
    return jsonify(database.get_dashboard_stats())

@app.route("/api/sets/import", methods=["POST"])
def run_import():
    import services.importer as importer
    n = importer.import_json_files()
    return jsonify({"ok": True, "imported": n})

# --- Static ---
@app.route("/snippets/<path:filename>")
def serve_snippets(filename):
    return send_from_directory(SNIPPET_DIR, filename)

@app.route("/static/<path:filename>")
def serve_static(filename):
    return send_from_directory(STATIC_DIR, filename)

@app.route("/static/js/<path:filename>")
def serve_js(filename):
    return send_from_directory(os.path.join(STATIC_DIR, "js"), filename)

if __name__ == "__main__":
    database.init_db()
    import services.importer as importer
    importer.import_json_files()
    print("Starte Server auf http://127.0.0.1:5000")
    app.run(host="0.0.0.0", port=5000, debug=True)
